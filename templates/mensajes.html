{% extends "base.html" %}
{% block content %}
<section class="fade-in py-5">
  <div class="container">
    <h2 class="title-gradient text-center mb-4">{{ t("Centro de Mensajes") }}</h2>

    <!-- üì© Enviar nuevo mensaje -->
    <div class="glass-card p-4 shadow-lg mb-4">
      <h5 class="mb-3 text-light">‚úâÔ∏è {{ t("Enviar un mensaje") }}</h5>
      <form method="POST" action="{{ url_for('mensajes') }}">
        <div class="form-floating mb-3">
          <input type="email" name="destino" id="destinoEmail" class="form-control"
                 placeholder="usuario@ejemplo.com" required>
          <label for="destinoEmail">{{ t("Destinatario (correo)") }}</label>
        </div>

        <div class="form-floating mb-3">
          <textarea name="contenido" id="mensajeContenido" class="form-control"
                    style="height:100px;" required></textarea>
          <label for="mensajeContenido">{{ t("Contenido del mensaje") }}</label>
        </div>

        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-lg">
            üì® {{ t("Enviar mensaje") }}
          </button>
        </div>
      </form>
    </div>

    <!-- üì® Bandeja de mensajes -->
    <div class="row">
      <!-- Bandeja de recibidos -->
      <div class="col-md-6 mb-4">
        <div class="glass-card shadow-sm p-3">
          <h5 class="text-light">üì• {{ t("Recibidos") }}</h5>
          {% if recibidos %}
            <ul class="list-group list-group-flush">
              {% for m in recibidos %}
              <li class="list-group-item bg-transparent text-light border-light">
                <strong>{{ m.origen }}</strong><br>
                {{ m.contenido }}<br>
                <small class="text-muted">{{ t("Recibido el") }} {{ m.fecha }}</small>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">{{ t("No tienes mensajes recibidos.") }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Bandeja de enviados -->
      <div class="col-md-6 mb-4">
        <div class="glass-card shadow-sm p-3">
          <h5 class="text-light">üì§ {{ t("Enviados") }}</h5>
          {% if enviados %}
            <ul class="list-group list-group-flush">
              {% for m in enviados %}
              <li class="list-group-item bg-transparent text-light border-light">
                <strong>{{ m.destino }}</strong><br>
                {{ m.contenido }}<br>
                <small class="text-muted">{{ t("Enviado el") }} {{ m.fecha }}</small>
                
                {# üïí Mostrar tiempo restante si fue enviado hace menos de 3 d√≠as #}
                {% set diff = (datetime.utcnow() - datetime.strptime(m.fecha, "%Y-%m-%d %H:%M")).total_seconds() if m.fecha else 0 %}
                {% if diff < 259200 %}
                  {% set horas_rest = (259200 - diff) / 3600 %}
                  <small class="text-warning d-block mt-1">
                    ‚è≥ {{ t("Podr√°s volver a escribir a este contacto en aproximadamente") }}
                    {{ horas_rest|round(0) }}h.
                  </small>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">{{ t("No has enviado mensajes.") }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- üîô Volver al panel correcto seg√∫n perfil -->
    <div class="text-center mt-4">
      {% if session.get('user') %}
        {% set u = session.get('user') %}
        {% if u.tipo == "extranjero" %}
          <a href="{{ url_for('dashboard_extranjero') }}" class="btn btn-outline-light">‚Üê {{ t("Volver al Panel") }}</a>
        {% elif u.tipo == "compraventa" %}
          <a href="{{ url_for('dashboard_compra') }}" class="btn btn-outline-light">‚Üê {{ t("Volver al Panel") }}</a>
        {% elif u.tipo == "mixto" %}
          <a href="{{ url_for('dashboard_mixto') }}" class="btn btn-outline-light">‚Üê {{ t("Volver al Panel") }}</a>
        {% elif u.tipo == "servicio" %}
          <a href="{{ url_for('dashboard_servicio') }}" class="btn btn-outline-light">‚Üê {{ t("Volver al Panel") }}</a>
        {% else %}
          <a href="{{ url_for('dashboard_admin') }}" class="btn btn-outline-light">‚Üê {{ t("Volver al Panel") }}</a>
        {% endif %}
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}
