# =========================================================
# üåê WINDOW SHOPPING ‚Äî Flask App (v3.4 limpio) ‚Äî BLOQUE 1
# Configuraci√≥n, DB, Helpers, Cach√© USERS, Carrito, Visibilidad
# =========================================================

import os
import sqlite3
import uuid
from datetime import timedelta, datetime
from typing import List, Dict, Any

from flask import (
    Flask, render_template, request, redirect, url_for,
    session, flash, abort, jsonify
)
from werkzeug.utils import secure_filename
from werkzeug.security import generate_password_hash, check_password_hash

# =========================================================
# üîß CONFIGURACI√ìN B√ÅSICA
# =========================================================
app = Flask(__name__)
app.secret_key = os.environ.get("SECRET_KEY", "dev-secret-key")
app.permanent_session_lifetime = timedelta(days=14)

# Directorios
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
STATIC_DIR = os.path.join(BASE_DIR, "static")
TEMPLATES_DIR = os.path.join(BASE_DIR, "templates")
UPLOAD_FOLDER = os.path.join(STATIC_DIR, "uploads")
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

# üîπ Subida de archivos
app.config["UPLOAD_FOLDER"] = UPLOAD_FOLDER
ALLOWED_EXT = {"pdf", "png", "jpg", "jpeg"}

def allowed_file(filename: str) -> bool:
    """Verifica si el archivo tiene una extensi√≥n v√°lida."""
    return "." in filename and filename.rsplit(".", 1)[1].lower() in ALLOWED_EXT

# =========================================================
# üåé SISTEMA MULTI-IDIOMA ‚Äî funci√≥n global t()
# (Rutas de idioma se definen en bloques posteriores)
# =========================================================
def t(es, en="", zh=""):
    lang = session.get("lang", "es")
    if lang == "en" and en:
        return en
    elif lang == "zh" and zh:
        return zh
    return es

# Exponer t() a Jinja
app.jinja_env.globals.update(t=t)

# =========================================================
# üß© TIPOS Y ROLES
# =========================================================
TIPOS_VALIDOS = {"compras", "servicios", "mixto", "compraventa"}

ROLES_POR_TIPO: Dict[str, List[str]] = {
    "compras": ["Cliente extranjero"],
    "servicios": ["Agencia de aduana", "Transporte", "Extraportuario", "Packing", "Frigor√≠fico"],
    "compraventa": ["Productor(planta)", "Packing", "Frigor√≠fico", "Exportador"],
    "mixto": ["Packing", "Frigor√≠fico"],
}

# =========================================================
# üóÑÔ∏è BASE DE DATOS (SQLite) ‚Äî Usuarios y autenticaci√≥n
# =========================================================
DB_PATH = os.path.join(BASE_DIR, "users.db")

def init_db():
    """Crea la tabla de usuarios si no existe."""
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("""
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            email TEXT UNIQUE NOT NULL,
            password TEXT NOT NULL,
            empresa TEXT,
            rol TEXT,
            tipo TEXT,
            pais TEXT,
            rut_doc TEXT,
            direccion TEXT,
            telefono TEXT
        )
    """)
    conn.commit()
    conn.close()

def migrate_add_column(colname: str):
    """Agrega una columna a la tabla users si no existe."""
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    try:
        c.execute(f"ALTER TABLE users ADD COLUMN {colname} TEXT")
        conn.commit()
        print(f"üõ†Ô∏è Migraci√≥n: columna '{colname}' agregada a users.")
    except sqlite3.OperationalError:
        # Ya existe
        pass
    finally:
        conn.close()

def migrate_add_rut_doc():
    migrate_add_column("rut_doc")

def migrate_add_contact_fields():
    migrate_add_column("direccion")
    migrate_add_column("telefono")

def get_user(email: str):
    """Obtiene un usuario por correo."""
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    c = conn.cursor()
    c.execute("SELECT * FROM users WHERE email = ?", (email,))
    user = c.fetchone()
    conn.close()
    return user

def get_all_users() -> List[sqlite3.Row]:
    """Devuelve todos los usuarios."""
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    c = conn.cursor()
    c.execute("SELECT * FROM users")
    rows = c.fetchall()
    conn.close()
    return rows

def add_user(email, password_hashed, empresa, rol, tipo, pais,
             rut_doc=None, direccion=None, telefono=None):
    """
    Agrega un nuevo usuario a la base de datos.
    ‚ö†Ô∏è password_hashed debe venir ya hasheado (generate_password_hash).
    """
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    try:
        c.execute("""
            INSERT INTO users (email, password, empresa, rol, tipo, pais, rut_doc, direccion, telefono)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (email, password_hashed, empresa, rol, tipo, pais, rut_doc, direccion, telefono))
        conn.commit()
        print(f"üÜï Usuario creado: {email}")
    except sqlite3.IntegrityError:
        print(f"‚ö†Ô∏è El usuario {email} ya existe.")
    finally:
        conn.close()

def update_user_fields(email: str, **fields):
    """Actualiza campos del usuario (empresa, rol, etc.)."""
    if not fields:
        return
    cols = ", ".join([f"{k}=?" for k in fields.keys()])
    vals = list(fields.values()) + [email]
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute(f"UPDATE users SET {cols} WHERE email=?", vals)
    conn.commit()
    conn.close()

# =========================================================
# üë§ SEMILLA ‚Äî Admin + Usuarios de demostraci√≥n
# =========================================================
def create_admin_if_missing():
    """Crea un usuario administrador por defecto (password '1234')."""
    if not get_user("admin@ws.com"):
        add_user(
            email="admin@ws.com",
            password_hashed=generate_password_hash("1234"),
            empresa="Window Shopping Admin",
            rol="Exportador",
            tipo="compraventa",
            pais="CL",
            rut_doc=None,
            direccion="Santiago, CL",
            telefono="+56 2 2222 2222",
        )
        print("‚úÖ Usuario admin creado: admin@ws.com / 1234")

def seed_demo_users():
    """Crea usuarios de demostraci√≥n por tipo y rol."""
    seeds = [
        # compraventa
        ("prod1@demo.cl","Productora Valle SpA","Productor(planta)","compraventa","CL","", "Curic√≥, CL","+56 9 1111 1111"),
        ("prod2@demo.cl","Agro Cordillera Ltda.","Productor(planta)","compraventa","CL","", "Rancagua, CL","+56 9 2222 2222"),
        ("pack1@demo.cl","Packing Maule SpA","Packing","compraventa","CL","", "Talca, CL","+56 9 3333 3333"),
        ("pack2@demo.cl","Packing Sur SpA","Packing","compraventa","CL","", "Osorno, CL","+56 9 4444 4444"),
        ("frio1@demo.cl","Fr√≠o Centro SpA","Frigor√≠fico","compraventa","CL","", "San Fernando, CL","+56 9 5555 5555"),
        ("frio2@demo.cl","Patagonia Cold SA","Frigor√≠fico","compraventa","CL","", "Punta Arenas, CL","+56 9 6666 6666"),
        ("exp1@demo.cl","Exportadora Andes","Exportador","compraventa","CL","", "Providencia, CL","+56 2 2345 6789"),
        ("exp2@demo.cl","Exportadora Pac√≠fico","Exportador","compraventa","CL","", "Vitacura, CL","+56 2 2567 8901"),
        # servicios / mixto / compras
        ("aduana1@demo.cl","Agencia Andes","Agencia de aduana","servicios","CL","", "Valpara√≠so, CL","+56 32 222 2222"),
        ("trans1@demo.cl","Transporte R√°pido","Transporte","servicios","CL","", "Santiago, CL","+56 2 2777 7777"),
        ("extra1@demo.cl","Extraportuario Norte","Extraportuario","servicios","CL","", "Antofagasta, CL","+56 55 2999 9999"),
        ("mixpack1@demo.cl","Mixto Packing Uno","Packing","mixto","CL","", "Talagante, CL","+56 2 2123 4567"),
        ("cliente1@ext.com","Importadora Asia Ltd.","Cliente extranjero","compras","US","", "Miami, US","+1 305 555 0101"),
    ]
    for email, empresa, rol, tipo, pais, rut_doc, direccion, telefono in seeds:
        if not get_user(email):
            add_user(
                email=email,
                password_hashed=generate_password_hash("1234"),
                empresa=empresa,
                rol=rol,
                tipo=tipo,
                pais=pais,
                rut_doc=rut_doc or None,
                direccion=direccion,
                telefono=telefono,
            )
            print(f"üßë‚Äçüíº Usuario demo agregado: {email}")

# =========================================================
# üë• CACH√â DE USUARIOS PARA VISTAS (/clientes, mensajer√≠a)
# (Se carga desde la DB y se puede refrescar)
# =========================================================
USERS: Dict[str, Dict[str, Any]] = {}

def _normaliza_items(items: List[Dict[str, Any]] | None) -> List[Dict[str, Any]]:
    out: List[Dict[str, Any]] = []
    for it in items or []:
        nombre = it.get("producto") or it.get("servicio") or it.get("variedad") or "Item"
        tipo = it.get("tipo") or "item"
        detalle = it.get("detalle") or it.get("descripcion") or ""
        out.append({"nombre": nombre, "tipo": tipo, "detalle": detalle})
    return out

def _armar_cliente_desde_users(username: str, data: Dict[str, Any]) -> Dict[str, Any]:
    return {
        "username": username,
        "empresa": data.get("empresa", username),
        "rol": data.get("rol", ""),
        "tipo": data.get("tipo", ""),
        "descripcion": data.get("descripcion", ""),
        "items": _normaliza_items(data.get("items")),
        "email": data.get("email", username),
        "perfil_tipo": data.get("tipo", ""),
    }

def load_users_cache():
    """Carga USERS desde la DB (m√≠nimo requerido por las vistas)."""
    USERS.clear()
    for row in get_all_users():
        USERS[row["email"]] = {
            "email": row["email"],
            "empresa": row["empresa"] or row["email"],
            "rol": row["rol"] or "",
            "tipo": row["tipo"] or "",
            "pais": row["pais"] or "",
            "direccion": row["direccion"] or "",
            "telefono": row["telefono"] or "",
            "descripcion": "",
            "items": [],  # opcional; se puede poblar desde otra fuente
        }

# =========================================================
# üõí CARRITO Y OCULTOS (helpers basados en sesi√≥n)
# =========================================================
def get_cart() -> List[Dict[str, Any]]:
    return session.setdefault("cart", [])

def save_cart(cart: List[Dict[str, Any]]) -> None:
    session["cart"] = cart

def add_to_cart(item: Dict[str, Any]) -> None:
    cart = get_cart()
    if not any(i.get("id") == item.get("id") for i in cart):
        cart.append(item)
        save_cart(cart)

def remove_from_cart(index: int) -> bool:
    cart = get_cart()
    if 0 <= index < len(cart):
        cart.pop(index)
        save_cart(cart)
        return True
    return False

def clear_cart() -> None:
    save_cart([])

def get_hidden_items() -> List[str]:
    return session.setdefault("hidden_items", [])

def hide_item(item_id: str) -> None:
    hidden = get_hidden_items()
    if item_id not in hidden:
        hidden.append(item_id)
        session["hidden_items"] = hidden

def unhide_all() -> None:
    session["hidden_items"] = []

# =========================================================
# üîê PERMISOS DE VISIBILIDAD + FILTRO DE PUBLICACIONES
# =========================================================
PERMISOS: Dict[str, Dict[str, List[str]]] = {
    "fruta_oferta_visible_por_rol": {
        "Packing": ["Productor(planta)"],
        "Frigor√≠fico": ["Productor(planta)", "Packing"],
        "Exportador": ["Productor(planta)", "Packing", "Frigor√≠fico", "Exportador"],
        "Cliente extranjero": ["Exportador"],
        "Productor(planta)": ["Packing", "Frigor√≠fico", "Exportador"],
        "Agencia de aduana": [], "Transporte": [], "Extraportuario": [],
    },
    "fruta_demanda_visible_por_rol": {
        "Productor(planta)": ["Exportador", "Packing", "Frigor√≠fico", "Productor(planta)"],
        "Packing": ["Exportador", "Frigor√≠fico", "Packing"],
        "Frigor√≠fico": ["Exportador", "Packing", "Frigor√≠fico"],
        "Exportador": ["Exportador"],
        "Cliente extranjero": ["Exportador"],
        "Agencia de aduana": [], "Transporte": [], "Extraportuario": [],
    },
    "servicios_compra_de": {
        "Productor(planta)": ["Transporte", "Packing", "Frigor√≠fico"],
        "Packing": ["Transporte", "Frigor√≠fico"],
        "Frigor√≠fico": ["Transporte", "Packing"],
        "Exportador": ["Agencia de aduana", "Transporte", "Extraportuario", "Packing", "Frigor√≠fico"],
        "Cliente extranjero": [],
        "Agencia de aduana": [], "Transporte": [], "Extraportuario": [],
    },
}

def publica_es_visible_para_rol(pub: Dict[str, Any], rol_usuario: str) -> bool:
    if not pub or not rol_usuario:
        return False
    tipo_pub = pub.get("tipo")
    rol_pub = pub.get("rol")
    if tipo_pub == "oferta":
        return rol_pub in PERMISOS["fruta_oferta_visible_por_rol"].get(rol_usuario, [])
    if tipo_pub == "demanda":
        return rol_pub in PERMISOS["fruta_demanda_visible_por_rol"].get(rol_usuario, [])
    if tipo_pub == "servicio":
        return rol_pub in PERMISOS["servicios_compra_de"].get(rol_usuario, [])
    return False

def publicaciones_visibles(usuario: Dict[str, Any], publicaciones: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """Filtra publicaciones por permisos y ocultas en sesi√≥n."""
    hidden = set(session.get("hidden_items", []))
    rol = (usuario or {}).get("rol", "")
    out: List[Dict[str, Any]] = []
    for p in publicaciones:
        if p.get("id") in hidden:
            continue
        if publica_es_visible_para_rol(p, rol):
            out.append(p)
    return out

# =========================================================
# üì¶ PUBLICACIONES DEMO (en memoria)
# (Las rutas se definen en el bloque de vistas)
# =========================================================
PUBLICACIONES: List[Dict[str, Any]] = [
    {
        "id": "pub1",
        "usuario": "exp1@demo.cl",
        "tipo": "oferta",
        "rol": "Exportador",
        "empresa": "Exportadora Andes",
        "producto": "Cerezas Premium",
        "precio": "USD 7/kg",
        "descripcion": "Lapins 28+, condici√≥n exportaci√≥n.",
        "fecha": "2025-10-01 09:00",
    },
    {
        "id": "pub2",
        "usuario": "pack1@demo.cl",
        "tipo": "servicio",
        "rol": "Packing",
        "empresa": "Packing Maule SpA",
        "producto": "Servicio de Embalaje",
        "precio": "USD 0.50/kg",
        "descripcion": "Clamshell y flowpack. BRC/IFS.",
        "fecha": "2025-10-02 10:00",
    },
    {
        "id": "pub3",
        "usuario": "frio1@demo.cl",
        "tipo": "servicio",
        "rol": "Frigor√≠fico",
        "empresa": "Fr√≠o Centro SpA",
        "producto": "Almacenamiento Refrigerado",
        "precio": "USD 0.20/kg",
        "descripcion": "C√°maras -1 a 10 ¬∞C, AC, monitoreo 24/7.",
        "fecha": "2025-10-03 11:00",
    },
    {
        "id": "pub4",
        "usuario": "cliente1@ext.com",
        "tipo": "demanda",
        "rol": "Cliente extranjero",
        "empresa": "Importadora Asia Ltd.",
        "producto": "Demanda Fruta Chilena",
        "precio": "Consultar",
        "descripcion": "Cereza, ar√°ndano y uva, semanas 46-3.",
        "fecha": "2025-10-04 12:00",
    },
]

# =========================================================
# üèÅ INICIALIZACI√ìN (al importar app.py)
# =========================================================
init_db()
migrate_add_rut_doc()
migrate_add_contact_fields()
create_admin_if_missing()
seed_demo_users()
load_users_cache()
print(f"‚úÖ USERS en cach√©: {len(USERS)} usuarios")
# =========================================================
# üåê WINDOW SHOPPING ‚Äî BLOQUE 2
# Rutas p√∫blicas, login/logout, registro, idioma, errores
# =========================================================

# =========================================================
# üè† HOME
# =========================================================
@app.route("/")
def home():
    """P√°gina principal"""
    titulo = t("Inicio", "Home", "‰∏ªÈ†Å")
    return render_template("home.html", titulo=titulo)

# =========================================================
# üîê LOGIN / LOGOUT / REGISTRO
# =========================================================
@app.route("/login", methods=["GET", "POST"])
def login():
    """Inicio de sesi√≥n de usuario"""
    if request.method == "POST":
        email = request.form.get("email", "").strip()
        password = request.form.get("password", "").strip()
        user = get_user(email)

        if user and check_password_hash(user["password"], password):
            session["user"] = dict(user)
            flash(t("Inicio de sesi√≥n exitoso", "Login successful", "ÁôªÂÖ•ÊàêÂäü"), "success")
            return redirect(url_for("dashboard_ext"))
        else:
            flash(t("Correo o contrase√±a incorrectos", "Invalid credentials", "ÈõªÂ≠êÈÉµ‰ª∂ÊàñÂØÜÁ¢ºÈåØË™§"), "error")

    return render_template("login.html", titulo=t("Iniciar sesi√≥n", "Login", "ÁôªÂÖ•"))


@app.route("/logout")
def logout():
    """Cerrar sesi√≥n"""
    session.pop("user", None)
    flash(t("Has cerrado sesi√≥n", "You have logged out", "ÊÇ®Â∑≤ÁôªÂá∫"), "info")
    return redirect(url_for("home"))


@app.route("/register_router")
def register_router():
    """Vista para elegir tipo de cuenta antes de registrarse"""
    return render_template("registro_tipo.html", titulo=t("Tipo de cuenta", "Account type", "Â∏≥Êà∂È°ûÂûã"))


@app.route("/register/<tipo>", methods=["GET", "POST"])
def register(tipo):
    """Registro de nuevos usuarios seg√∫n tipo de cuenta"""
    if request.method == "POST":
        data = {k: request.form.get(k, "").strip() for k in
                ["email", "password", "empresa", "rol", "pais", "direccion", "telefono"]}
        file = request.files.get("rut_doc")
        rut_path = save_uploaded_file(file)

        # üîπ Validaci√≥n
        if not data["email"] or not data["password"]:
            flash(t("El correo y la contrase√±a son obligatorios.",
                    "Email and password are required.",
                    "ÂøÖÈ†àËº∏ÂÖ•ÈõªÂ≠êÈÉµ‰ª∂ÂíåÂØÜÁ¢º"), "error")
            return redirect(request.url)

        # Hash de la contrase√±a
        password_hashed = generate_password_hash(data["password"])

        add_user(
            email=data["email"],
            password_hashed=password_hashed,
            empresa=data["empresa"],
            rol=data["rol"],
            tipo=tipo,
            pais=data["pais"],
            rut_doc=rut_path,
            direccion=data["direccion"],
            telefono=data["telefono"],
        )

        # Actualizar cach√© local
        load_users_cache()
        flash(t("Registro exitoso", "Registration successful", "Ë®ªÂÜäÊàêÂäü"), "success")
        return redirect(url_for("login"))

    roles = ROLES_POR_TIPO.get(tipo, [])
    return render_template("registro.html", tipo=tipo, roles=roles, titulo=t("Registro", "Register", "Ë®ªÂÜä"))


# =========================================================
# üåç CAMBIO DE IDIOMA (banderas)
# =========================================================
@app.route("/lang/<code>")
def cambiar_idioma(code):
    """Ruta r√°pida para cambiar idioma (banderas)."""
    session["lang"] = code if code in ["es", "en", "zh"] else "es"
    flash(t("Idioma actualizado correctamente.", "Language updated successfully.", "Ë™ûË®ÄÂ∑≤ÊàêÂäüÊõ¥Êñ∞"), "info")
    return redirect(request.referrer or url_for("home"))


@app.route("/set_lang/<lang>", methods=["GET", "POST"])
def set_lang(lang):
    """Alias m√°s formal para cambio de idioma"""
    if lang not in ["es", "en", "zh"]:
        flash(t("Idioma no soportado.", "Unsupported language.", "‰∏çÊîØÊè¥ÁöÑË™ûË®Ä"), "error")
        return redirect(request.referrer or url_for("home"))
    session["lang"] = lang
    flash(t("Idioma actualizado correctamente.", "Language updated successfully.", "Ë™ûË®ÄÂ∑≤ÊàêÂäüÊõ¥Êñ∞"), "info")
    return redirect(request.referrer or url_for("home"))


# =========================================================
# üö® ERRORES PERSONALIZADOS (404 / 500)
# =========================================================
@app.errorhandler(404)
def error_404(e):
    """P√°gina no encontrada (Error 404)"""
    return render_template(
        "error.html",
        code=404,
        mensaje=t("P√°gina no encontrada", "Page not found", "Êâæ‰∏çÂà∞È†ÅÈù¢")
    ), 404


@app.errorhandler(500)
def error_500(e):
    """Error interno del servidor (Error 500)"""
    return render_template(
        "error.html",
        code=500,
        mensaje=t("Error interno del servidor", "Internal server error", "‰º∫ÊúçÂô®ÂÖßÈÉ®ÈåØË™§")
    ), 500
# =========================================================
# üåê WINDOW SHOPPING ‚Äî BLOQUE 3
# Dashboard Extendido + Carrito + Ocultar Publicaciones
# =========================================================

# =========================================================
# üß≠ DASHBOARD EXTENDIDO
# =========================================================
@app.route("/dashboard_ext", methods=["GET", "POST"])
def dashboard_ext():
    """Panel extendido del usuario con filtros din√°micos"""
    user = session.get("user")
    if not user:
        flash(t("Debes iniciar sesi√≥n.", "You must log in.", "ÊÇ®ÂøÖÈ†àÁôªÂÖ•"), "error")
        return redirect(url_for("login"))

    rol = user.get("rol", "")
    filtro = request.args.get("filtro", "oferta").lower()

    # üîπ Validar filtro
    if filtro not in ["oferta", "demanda", "servicio"]:
        flash(t("Filtro inv√°lido", "Invalid filter", "ÁÑ°ÊïàÁöÑÁØ©ÈÅ∏Ê¢ù‰ª∂"), "error")
        filtro = "oferta"

    # üîπ Publicaciones visibles seg√∫n permisos del rol
    visibles = [
        p for p in PUBLICACIONES
        if publica_es_visible_para_rol(p, rol) and p.get("tipo") == filtro
    ]
    visibles.sort(key=lambda p: p.get("fecha", ""), reverse=True)

    # üîπ Publicaciones propias del usuario
    propias = [p for p in PUBLICACIONES if p["usuario"] == user["email"]]
    propias.sort(key=lambda p: p.get("fecha", ""), reverse=True)

    return render_template(
        "dashboard.html",
        user=user,
        publicaciones=visibles,
        propias=propias,
        filtro=filtro,
        titulo=t("Panel de Usuario", "User Dashboard", "Áî®Êà∂‰∏ªÈ†Å")
    )


@app.route("/dashboard/filtro/<tipo>")
def cambiar_filtro_dashboard(tipo):
    """Cambia el filtro de vista del panel (oferta/demanda/servicio)"""
    tipo = tipo.lower()
    if tipo not in ["oferta", "demanda", "servicio"]:
        flash(t("Filtro inv√°lido", "Invalid filter", "ÁÑ°ÊïàÁöÑÁØ©ÈÅ∏Ê¢ù‰ª∂"), "error")
        return redirect(url_for("dashboard_ext"))
    return redirect(url_for("dashboard_ext", filtro=tipo))


# =========================================================
# üß∫ CARRITO DE COMPRAS
# =========================================================
@app.route("/carrito")
def carrito():
    """Muestra el carrito actual"""
    cart = get_cart()
    return render_template("carrito.html", cart=cart, titulo=t("Carrito", "Cart", "Ë≥ºÁâ©Ëªä"))


@app.route("/carrito/agregar/<pub_id>", methods=["POST", "GET"])
def carrito_agregar(pub_id):
    """Agrega una publicaci√≥n al carrito"""
    pub = next((p for p in PUBLICACIONES if p["id"] == pub_id), None)
    if not pub:
        flash(t("Publicaci√≥n no encontrada", "Item not found", "Êâæ‰∏çÂà∞È†ÖÁõÆ"), "error")
        return redirect(request.referrer or url_for("dashboard_ext"))

    add_to_cart(pub)
    flash(t("Agregado al carrito", "Added to cart", "Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ëªä"), "success")
    return redirect(request.referrer or url_for("carrito"))


@app.route("/carrito/eliminar/<int:index>", methods=["POST"])
def carrito_eliminar(index):
    """Elimina un √≠tem del carrito por √≠ndice"""
    if remove_from_cart(index):
        flash(t("Eliminado del carrito", "Removed from cart", "Â∑≤Âà™Èô§"), "info")
    else:
        flash(t("√çtem no v√°lido o inexistente",
                "Invalid or missing item",
                "ÁÑ°ÊïàÊàñ‰∏çÂ≠òÂú®ÁöÑÈ†ÖÁõÆ"), "error")
    return redirect(url_for("carrito"))


@app.route("/carrito/vaciar", methods=["POST"])
def carrito_vaciar():
    """Vac√≠a el carrito completo"""
    clear_cart()
    flash(t("Carrito vaciado", "Cart cleared", "Ë≥ºÁâ©ËªäÂ∑≤Ê∏ÖÁ©∫"), "info")
    return redirect(url_for("carrito"))


# =========================================================
# üß± PUBLICACIONES: OCULTAR / RESTAURAR
# =========================================================
@app.route("/ocultar/<pub_id>", methods=["POST"])
def ocultar_publicacion(pub_id):
    """Oculta una publicaci√≥n del panel"""
    hide_item(pub_id)
    flash(t("Publicaci√≥n ocultada", "Item hidden", "È†ÖÁõÆÂ∑≤Èö±Ëóè"), "info")
    return redirect(url_for("dashboard_ext"))


@app.route("/restablecer_ocultos", methods=["POST"])
def restablecer_ocultos():
    """Restaura publicaciones ocultas"""
    unhide_all()
    flash(t("Publicaciones restauradas", "Hidden items restored", "Â∑≤ÊÅ¢Âæ©Èö±ËóèÈ†ÖÁõÆ"), "success")
    return redirect(url_for("dashboard_ext"))
# =========================================================
# üåê WINDOW SHOPPING ‚Äî BLOQUE 4 FINAL
# Publicaciones, Mensajer√≠a, Perfil, Ayuda, Acerca, Estado
# =========================================================

# =========================================================
# üß© GESTI√ìN DE PUBLICACIONES
# =========================================================
SUBTIPOS_POR_TIPO = {
    "oferta": ["Compra", "Venta", "Servicio"],
    "demanda": ["Compra", "Venta", "Servicio"],
}

@app.route("/publicar", methods=["GET", "POST"])
def publicar():
    """Permite crear una nueva publicaci√≥n"""
    user = session.get("user")
    if not user:
        flash(t("Debes iniciar sesi√≥n para publicar.", "You must log in to post.", "ÊÇ®ÂøÖÈ†àÁôªÂÖ•‰ª•ÁôºÂ∏É"), "error")
        return redirect(url_for("login"))

    if request.method == "POST":
        tipo_pub = request.form.get("tipo_pub", "").lower().strip()
        subtipo = request.form.get("subtipo", "").lower().strip()
        producto = request.form.get("producto", "").strip()
        descripcion = request.form.get("descripcion", "").strip()
        precio = request.form.get("precio", "").strip()

        # Validaciones
        if not all([tipo_pub, subtipo, producto, descripcion]):
            flash(t("Todos los campos son obligatorios.", "All fields are required.", "ÊâÄÊúâÊ¨Ñ‰ΩçÈÉΩÊòØÂøÖÂ°´ÁöÑ"), "error")
            return redirect(url_for("publicar"))

        if tipo_pub not in ["oferta", "demanda", "servicio"]:
            flash(t("Tipo inv√°lido.", "Invalid type.", "ÁÑ°ÊïàÁöÑÈ°ûÂûã"), "error")
            return redirect(url_for("publicar"))

        if not precio:
            precio = "Consultar"

        pub_id = f"pub_{uuid.uuid4().hex[:8]}"
        nueva_pub = {
            "id": pub_id,
            "usuario": user.get("email"),
            "tipo": tipo_pub,
            "rol": user.get("rol"),
            "empresa": user.get("empresa"),
            "producto": producto,
            "precio": precio,
            "descripcion": f"{subtipo.upper()} ‚Äî {descripcion}",
            "fecha": datetime.now().strftime("%Y-%m-%d %H:%M"),
        }

        PUBLICACIONES.append(nueva_pub)
        flash(t("Publicaci√≥n agregada correctamente.", "Post added successfully.", "ÊàêÂäüÊñ∞Â¢ûÁôºÂ∏É"), "success")
        return redirect(url_for("dashboard_ext"))

    return render_template(
        "publicar.html",
        subtipo_opciones=SUBTIPOS_POR_TIPO,
        titulo=t("Nueva Publicaci√≥n", "New Post", "Êñ∞Â¢ûÁôºÂ∏É"),
        user=user
    )


@app.route("/publicacion/eliminar/<pub_id>", methods=["POST"])
def eliminar_publicacion(pub_id):
    """Elimina una publicaci√≥n propia"""
    user = session.get("user")
    if not user:
        flash(t("Debes iniciar sesi√≥n.", "You must log in.", "ÊÇ®ÂøÖÈ†àÁôªÂÖ•"), "error")
        return redirect(url_for("login"))

    global PUBLICACIONES
    antes = len(PUBLICACIONES)
    PUBLICACIONES = [
        p for p in PUBLICACIONES if not (p["id"] == pub_id and p["usuario"] == user["email"])
    ]
    despues = len(PUBLICACIONES)

    if antes > despues:
        flash(t("Publicaci√≥n eliminada correctamente.", "Post deleted successfully.", "Â∑≤Âà™Èô§ÁôºÂ∏É"), "success")
    else:
        flash(t("No se encontr√≥ la publicaci√≥n o no tienes permiso.", "Not found or no permission.", "Êú™ÊâæÂà∞ÊàñÁÑ°Ê¨äÈôê"), "error")

    return redirect(url_for("dashboard_ext"))


# =========================================================
# üí¨ MENSAJER√çA ENTRE USUARIOS (DEMO)
# =========================================================
MENSAJES = []  # Memoria temporal

@app.route("/mensajes", methods=["GET", "POST"])
def mensajes():
    """Env√≠o y visualizaci√≥n de mensajes simples (demo)"""
    user = session.get("user")
    if not user:
        flash(t("Debes iniciar sesi√≥n.", "You must log in.", "ÊÇ®ÂøÖÈ†àÁôªÂÖ•"), "error")
        return redirect(url_for("login"))

    if request.method == "POST":
        destino = request.form.get("destino", "").strip()
        contenido = request.form.get("contenido", "").strip()

        if not destino or not contenido:
            flash(t("Debes completar todos los campos.", "All fields required.", "Ë´ãÂ°´ÂØ´ÊâÄÊúâÊ¨Ñ‰Ωç"), "error")
            return redirect(url_for("mensajes"))

        if destino not in USERS:
            flash(t("El destinatario no existe.", "Recipient not found.", "Êâæ‰∏çÂà∞Êî∂‰ª∂‰∫∫"), "error")
            return redirect(url_for("mensajes"))

        MENSAJES.append({
            "origen": user["email"],
            "destino": destino,
            "contenido": contenido,
            "fecha": datetime.now().strftime("%Y-%m-%d %H:%M"),
        })

        flash(t("Mensaje enviado correctamente.", "Message sent successfully.", "Ë®äÊÅØÂ∑≤ÁôºÈÄÅ"), "success")
        return redirect(url_for("mensajes"))

    # Mensajes recibidos/enviados
    recibidos = sorted([m for m in MENSAJES if m["destino"] == user["email"]],
                       key=lambda x: x["fecha"], reverse=True)
    enviados = sorted([m for m in MENSAJES if m["origen"] == user["email"]],
                      key=lambda x: x["fecha"], reverse=True)

    return render_template(
        "mensajes.html",
        user=user,
        recibidos=recibidos,
        enviados=enviados,
        titulo=t("Mensajer√≠a", "Messaging", "Ë®äÊÅØÁ≥ªÁµ±"),
    )


# =========================================================
# üë§ PERFIL DE USUARIO
# =========================================================
@app.route("/perfil", methods=["GET", "POST"])
def perfil():
    """Visualiza y permite editar la informaci√≥n b√°sica del usuario"""
    user = session.get("user")
    if not user:
        flash(t("Debes iniciar sesi√≥n para ver tu perfil.", "You must log in to view your profile.", "ÊÇ®ÂøÖÈ†àÁôªÂÖ•‰ª•Ê™¢Ë¶ñÂÄã‰∫∫Ë≥áÊñô"), "error")
        return redirect(url_for("login"))

    if request.method == "POST":
        nueva_empresa = request.form.get("empresa", "").strip()
        nuevo_rol = request.form.get("rol", "").strip()

        if nueva_empresa:
            user["empresa"] = nueva_empresa
        if nuevo_rol:
            user["rol"] = nuevo_rol

        update_user_fields(user["email"], empresa=user["empresa"], rol=user["rol"])
        flash(t("Perfil actualizado correctamente.", "Profile updated successfully.", "ÂÄã‰∫∫Ë≥áÊñôÂ∑≤Êõ¥Êñ∞"), "success")
        return redirect(url_for("perfil"))

    return render_template("perfil.html", user=user, titulo=t("Tu Perfil", "Your Profile", "ÂÄã‰∫∫Ë≥áÊñô"))


# =========================================================
# üß≠ AYUDA / ACERCA / STATUS
# =========================================================
@app.route("/ayuda")
def ayuda():
    """Centro de ayuda general."""
    return render_template("ayuda.html", titulo=t("Centro de Ayuda", "Help Center", "Âπ´Âä©‰∏≠ÂøÉ"))


@app.route("/acerca")
def acerca():
    """Informaci√≥n del proyecto Window Shopping."""
    return render_template("acerca.html", titulo=t("Acerca de Window Shopping", "About Window Shopping", "ÈóúÊñº Window Shopping"))


@app.route("/status")
def status():
    """Muestra informaci√≥n general del sistema."""
    estado = {
        "usuarios": len(USERS),
        "publicaciones": len(PUBLICACIONES),
        "mensajes": len(MENSAJES),
        "idioma": session.get("lang", "es"),
        "estado": "OK ‚úÖ",
    }
    return jsonify(estado)


# =========================================================
# üöÄ EJECUCI√ìN LOCAL / DEPLOY
# =========================================================
if __name__ == "__main__":
    print("üåê Servidor Flask ejecut√°ndose en http://127.0.0.1:5000")
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)), debug=True)
